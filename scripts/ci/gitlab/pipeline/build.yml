# This file is part of .gitlab-ci.yml
# Here are all jobs that are executed during "build" stage

# PIPELINE_SCRIPTS_TAG can be found in the project variables

.check-dependent-project:
  stage:                           build
  extends:
    - .docker-env
    - .test-refs-no-trigger-prs-only
  script:
    - git clone
        --depth=1
        --branch=issue-49
        https://github.com/joao-paulo-parity/pipeline-scripts
    - ./pipeline-scripts/check_dependent_project.sh
        --org paritytech
        --dependent-repo "$DEPENDENT_REPO"
        --github-api-token "$GITHUB_PR_TOKEN"
        --extra-dependencies "$EXTRA_DEPENDENCIES"
        --companion-overrides "$COMPANION_OVERRIDES"

# Individual jobs are set up for each dependent project so that they can be ran in parallel.
# Arguably we could generate a job for each companion in the PR's description using Gitlab's
# parent-child pipelines but that's more complicated.

check-dependent-polkadot:
  extends:                         .check-dependent-project
  variables:
    DEPENDENT_REPO:                polkadot
    COMPANION_OVERRIDES: |
      substrate: polkadot-v*
      polkadot: release-v*
  rules:
    - if: $CI_COMMIT_REF_NAME =~ /^[0-9]+$/  #PRs
