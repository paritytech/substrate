# This file is part of .gitlab-ci.yml
# Here are all jobs that are executed during "test" stage

.cargo-check-benches:
  stage:                           test
  variables:
    # Override to use nightly toolchain
    RUSTY_CACHIER_TOOLCHAIN:       "nightly"
    CI_JOB_NAME:                   "cargo-check-benches-debug"
  extends:
    - .docker-env
    - .test-refs-check-benches
    - .collect-artifacts
    - .pipeline-stopper-artifacts
  before_script:
    # perform rusty-cachier operations before any further modifications to the git repo to make cargo feel cheated not so much
    - !reference [.rust-info-script, script]
    - !reference [.rusty-cachier, before_script]
    - !reference [.pipeline-stopper-vars, script]
    # merges in the master branch on PRs
    - if [ $CI_COMMIT_REF_NAME != "master" ]; then
        git fetch origin +master:master;
        git fetch origin +$CI_COMMIT_REF_NAME:$CI_COMMIT_REF_NAME;
        git checkout master;
        git config user.email "ci@gitlab.parity.io";
        git merge $CI_COMMIT_REF_NAME --verbose --no-edit;
      fi
  script:
    - rusty-cachier snapshot create
    - mkdir -p ./artifacts/benches/$CI_COMMIT_REF_NAME-$CI_COMMIT_SHORT_SHA
    - echo "___Running benchmarks___";
    - SKIP_WASM_BUILD=1 time cargo +nightly check --locked --benches --all;
      cargo run --locked --release -p node-bench -- ::trie::read::small --json
      | tee ./artifacts/benches/$CI_COMMIT_REF_NAME-$CI_COMMIT_SHORT_SHA/::trie::read::small.json;
    - cargo run --locked --release -p node-bench -- ::node::import::native::sr25519::transfer_keep_alive::paritydb::small --json
      | tee ./artifacts/benches/$CI_COMMIT_REF_NAME-$CI_COMMIT_SHORT_SHA/::node::import::native::sr25519::transfer_keep_alive::paritydb::small.json

cargo-check-benches-ci5:
  extends:
    - .cargo-check-benches
  tags:
    - ci5

cargo-check-benches-ci6:
  extends:
    - .cargo-check-benches
  tags:
    - ci6
