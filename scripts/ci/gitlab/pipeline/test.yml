test-deterministic-wasm:
  stage:                           test
  extends:
    - .docker-env
    - .test-refs
  variables:
    WASM_BUILD_NO_COLOR:           1
    # this variable gets overriden by "rusty-cachier environment inject", use the value as default
    CARGO_TARGET_DIR:              "$CI_PROJECT_DIR/target"
  script:
    - rusty-cachier snapshot create
    # build runtime
    - cargo build --verbose --release -p node-runtime
    # make checksum
    - sha256sum $CARGO_TARGET_DIR/release/wbuild/node-runtime/target/wasm32-unknown-unknown/release/node_runtime.wasm > checksum.sha256
    # clean up
    - rm -rf $CARGO_TARGET_DIR/release/wbuild
    # build again
    - cargo build --verbose --release -p node-runtime
    # confirm checksum
    - sha256sum -c ./checksum.sha256
    # clean up again, don't put release binaries into the cache
    - rm -rf $CARGO_TARGET_DIR/release/wbuild
    - rusty-cachier cache upload
